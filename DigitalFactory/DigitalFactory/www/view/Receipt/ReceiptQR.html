<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>数字工厂 - 红狮</title>
    <!-- Bootstrap CSS CDN -->
    <!-- Bootstrap core CSS -->
    <link href="../../lib/bootstrap/css/bootstrap-reboot.min.css" rel="stylesheet">
    <link href="../../lib/bootstrap/css/bootstrap-grid.min.css" rel="stylesheet">
    <link href="../../lib/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <!-- Our Custom CSS -->
    <link rel="stylesheet" href="../../css/style.css">
    <!-- Scrollbar Custom CSS -->
    <link rel="stylesheet" href="../../lib/mCustomScrollbar/jquery.mCustomScrollbar.min.css">
    <!-- Font Awesome JS -->
    <link href="../../lib/font-awesome/css/all.css" rel="stylesheet">
    <!--<script defer src="../../lib/font-awesome/js/all.js"></script>-->

</head>

<body onload="onload()">
    <script src="../../scripts/jquery.js"></script>
    <script type="text/javascript">
        function onload() {
            var login = window.localStorage.a;
            if (login != 1) {
                setTimeout(function () {
                    alert("请先登录");
                    location.href = "../../index.html";
                }, 1000);
            }
            $("#txtBarcode").focus();
        }
        $(document).ready(function () {
            $("#sidebar").mCustomScrollbar({
                theme: "minimal"
            });

            $('#dismiss, .overlay').on('click', function () {
                $('#sidebar').removeClass('active');
                $('.overlay').removeClass('active');
            });

            $('#sidebarCollapse').on('click', function () {
                $('#sidebar').addClass('active');
                $('.overlay').addClass('active');
                $('.collapse.in').toggleClass('in');
                $('a[aria-expanded=true]').attr('aria-expanded', 'false');
            });
            $("#sidebar1").load("../../header.html");
        });

        //扫码
        function scanCode() {
            cordova.plugins.barcodeScanner.scan(
                function (result) {
                    var reg = new RegExp("(%)", "g");
                    result = result.replace(reg, '~');
                    //console.log(result);
                    $.ajax({
                        type: "get",
                        contentType: "application/json",
                        url: "http://192.168.9.49/api/Receipt/ParseQRValues?values=" + result + "",
                        //data: "{'SupplierNo':" + supplierno + "}",
                        dataType: 'json',
                        error: function (xhr, status, p3, p4) {
                            //console.log(xhr);
                            var err = "Error " + " " + status + " " + p3;
                            if (xhr.responseText && xhr.responseText[0] == "{")
                                err = JSON.parse(xhr.responseText).message;
                            alert("扫码失败ParseQRValues，" + err + ",请尝试重新登录");
                        },
                        success: function (result) {
                            console.log(result);
                            if (result != null) {
                                var mycars = result.split("~");
                                console.log(mycars);
                                document.getElementById('Company').value = mycars[0] === null ? "" : mycars[0];
                                document.getElementById('Partnum').value = mycars[1] === null ? "" : mycars[1];
                                document.getElementById('Partdescription').value = mycars[2] === null ? "" : mycars[2];
                                document.getElementById('BatchNo').value = mycars[3] === null ? "" : mycars[3];
                                document.getElementById('Jobnum').value = mycars[4] === null ? "" : mycars[4];
                                document.getElementById('AssmbelNum').value = mycars[5];
                                //document.getElementById('textId').value = mycars[6];
                                document.getElementById('SupplierNo').value = mycars[7] === null ? "" : mycars[7];
                                document.getElementById('POnum').value = mycars[8] === null ? "" : mycars[8];
                                document.getElementById('POline').value = mycars[9] === null ? "" : mycars[9];
                                document.getElementById('receiveQty').value = mycars[10] === null ? "" : mycars[10];
                                document.getElementById('POrelnum').value = mycars[11] === null ? "" : mycars[11];
                                document.getElementById('Jobseq').value = mycars[12];
                                document.getElementById('HeatNum').value = mycars[13] === null ? "" : mycars[13];
                                document.getElementById('plant').value = mycars[14];
                                document.getElementById('SupplierName').value = mycars[15];
                                $.ajax({
                                    type: "get",
                                    contentType: "application/json",
                                    url: "http://192.168.9.49/api/Receipt/GetNextUserGroup?nextStatus=1&company=" + mycars[0] + "&plant=" + mycars[14] + "&ID=1",
                                    //data: "{'value':1}",
                                    dataType: 'json',
                                    error: function (ex) { },
                                    success: function (result) {
                                        //console.log(result);
                                        $("#SecondUserGroup").empty();
                                        //var people = result.split(",");
                                        for (var i = 0; i < result.length; i++) {
                                            if (result[i] != "") {
                                                $("#SecondUserGroup").append('<option value=' + result[i]["UserID"] + '>' + result[i]["UserName"] + '(' + result[i]["UserID"] + ')' +'</option>');
                                            }
                                        }
                                    }
                                });
                            }
                        }
                    });
                },
                function (error) {
                    alert("Scanning failed: " + error);
                }
            );
        }
        function BarcodeScan() {
            if (event.keyCode === 13) {
                result = $("#txtBarcode").val();
                var reg = new RegExp("(%)", "g");
                result = result.replace(reg, '~');
                //console.log(result);
                $.ajax({
                    type: "get",
                    contentType: "application/json",
                    url: "http://192.168.9.49/api/Receipt/ParseQRValues?values=" + result + "",
                    //data: "{'SupplierNo':" + supplierno + "}",
                    dataType: 'json',
                    error: function (xhr, status, p3, p4) {
                        //console.log(xhr);
                        var err = "Error " + " " + status + " " + p3;
                        if (xhr.responseText && xhr.responseText[0] == "{")
                            err = JSON.parse(xhr.responseText).message;
                        alert("扫码失败ParseQRValues，" + err + ",请尝试重新登录");
                    },
                    success: function (result) {
                        //console.log(result);
                        if (result != null) {
                            var mycars = result.split("~");
                            //console.log(mycars);
                            document.getElementById('Company').value = mycars[0] === null ? "" : mycars[0];
                            document.getElementById('Partnum').value = mycars[1] === null ? "" : mycars[1];
                            document.getElementById('Partdescription').value = mycars[2] === null ? "" : mycars[2];
                            document.getElementById('BatchNo').value = mycars[3] === null ? "" : mycars[3];
                            document.getElementById('Jobnum').value = mycars[4] === null ? "" : mycars[4];
                            document.getElementById('AssmbelNum').value = mycars[5];
                            //document.getElementById('textId').value = mycars[6];
                            document.getElementById('SupplierNo').value = mycars[7] === null ? "" : mycars[7];
                            document.getElementById('POnum').value = mycars[8] === null ? "" : mycars[8];
                            document.getElementById('POline').value = mycars[9] === null ? "" : mycars[9];
                            document.getElementById('receiveQty').value = mycars[10] === null ? "" : mycars[10];
                            document.getElementById('POrelnum').value = mycars[11] === null ? "" : mycars[11];
                            document.getElementById('Jobseq').value = mycars[12];
                            document.getElementById('HeatNum').value = mycars[13] === null ? "" : mycars[13];
                            document.getElementById('plant').value = mycars[14];
                            document.getElementById('SupplierName').value = mycars[15];
                            $.ajax({
                                type: "get",
                                contentType: "application/json",
                                url: "http://192.168.9.49/api/Receipt/GetNextUserGroup?nextStatus=2&company=" + mycars[0] + "&plant=" + mycars[14] + "&ID=1",
                                //data: "{'value':1}",
                                dataType: 'json',
                                error: function (xhr, status, p3, p4) {
                                    //console.log(xhr);
                                    var err = "Error " + " " + status + " " + p3;
                                    if (xhr.responseText && xhr.responseText[0] == "{")
                                        err = JSON.parse(xhr.responseText).message;
                                    alert("扫码失败GetNextUserGroup，" + err + ",请尝试重新登录");
                                },
                                success: function (result) {
                                    //console.log(result);
                                    //var people = result.split(",");
                                    $("#SecondUserGroup").empty();
                                    for (var i = 0; i < result.length; i++) {
                                        if (result[i] != "") {
                                            $("#SecondUserGroup").append('<option value=' + result[i]["UserID"] + '>' + result[i]["UserName"] + '('+result[i]["UserID"]+')'+'</option>');
                                        }
                                    }
                                }
                            });
                        }
                    }
                });
            }
        }
        //提交
        function Recvive() {
            $(".btn").attr("disabled", true);
            var companyid = $("#Company").val();
            var SupplierNo = $("#SupplierNo").val();
            var SupplierName = $("#SupplierName").val();
            var ReceiptDate = $("#ReceiptDate").val();
            var POnum = parseInt($("#POnum").val());
            var POline = parseInt($("#POline").val());
            var POrelnum = parseInt($("#POrelnum").val());
            var Partnum = $("#Partnum").val();
            var Partdescription = $("#Partdescription").val();
            var BatchNo = $("#BatchNo").val();
            var HeatNum = $("#HeatNum").val();
            var Jobnum = $("#Jobnum").val();
            var receiveQty = $("#receiveQty").val();
            var Remark = $("#Remark").val();
            var Group = $("#SecondUserGroup").val();
            var Plant = $("#plant").val();
            var JobSeq = $("#Jobseq").val();
            var AssemblySeq=$("#AssmbelNum").val();
            var SecondUserGroup = "";
            for (var i = 0; i < Group.length; i++) {
                SecondUserGroup += Group[i] + ",";
            }
            if (SecondUserGroup=="") {
                alert("请选择下步接收人");
                window.location.reload();
                return;
            }
            //var data = '[{"Company": "' + companyid + '", "SupplierNo": "' + SupplierNo + '", "SupplierName": "' + SupplierName + '", "ReceiptDate": "' + ReceiptDate +
            //    '","PoNum": "' + POnum + '", "PoLine": "' + POline + '", "PORelNum": "' + POrelnum + '", "PartNum": "' + Partnum + '", "PartDesc": "' + Partdescription +
            //    '", "BatchNo": "' + BatchNo + '", "HeatNum": "' + HeatNum + '", "JobNum": "' + Jobnum + '", "ReceiveQty1": "' + receiveQty + '", "Remark": "' + Remark +
            //    '", "SecondUserGroup": "' + SecondUserGroup + '"}]';
            var data = "{'Company': '" + companyid + "', 'SupplierNo': '" + SupplierNo + "', 'SupplierName': '" + SupplierName + "', 'ReceiptDate': '" + ReceiptDate + "', 'PoNum': " + POnum +
                ", 'PoLine': " + POline + ", 'PORelNum': " + POrelnum + ", 'PartNum': '" + Partnum + "', 'PartDesc': '" + Partdescription + "', 'BatchNo': '" + BatchNo + "', 'HeatNum': '" + HeatNum +
                "', 'JobNum': '" + Jobnum + "', 'ReceiveQty1': " + receiveQty + ", 'Remark': '" + Remark + "', 'SecondUserGroup': '" + SecondUserGroup + "','Plant':'" + Plant + "','JobSeq':'" + JobSeq +
                "','AssemblySeq':'" + AssemblySeq + "'}";
            //console.log(data);
            $.ajax({
                type: "post",
                contentType: "application/json",
                url: "http://192.168.9.49/api/Receipt/ReceiveCommitWithQRCode",
                data: data,
                //dataType: 'json',
                error: function (xhr, status, p3, p4) {
                    //console.log(xhr);
                    var err = "Error " + " " + status + " " + p3;
                    if (xhr.responseText && xhr.responseText[0] == "{")
                        err = JSON.parse(xhr.responseText).message;
                    alert("提交失败ReceiveCommitWithQRCode，" + err + ",请尝试重新登录");
                },
                success: function (result) {
                    alert(result);
                    $(".row input").val("");
                    $("#SecondUserGroup").html("");
                    window.location.reload();
                }
            });
        }
        function signout() {
            console.log(111);
            $.ajax({
                type: "get",
                contentType: "application/json",
                url: "http://192.168.9.49/api/Receipt/SignOut",
                //data: "{'value':1}",
                dataType: 'json',
                error: function (ex) {
                    alert("Signout，" + ex.error + ",请关闭程序重新打开");
                    return;
                },
                success: function (result) {
                    window.localStorage.clear();
                    console.log(222);
                    location.href = "../../index.html";
                }
            });
        }
    </script>
    <!-- Sidebar  -->
    <div id="sidebar1">
    </div>
    <!-- Page Content  -->
    <div class="content">
        <header>
            <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
                <div class="container-fluid">
                    <a class="navbar-brand mr-auto mr-lg-0" href="#">红狮数字工厂</a>

                    <button class="btn btn-dark d-inline-block d-lg-none ml-auto" type="button" data-toggle="collapse"
                            data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false"
                            aria-label="Toggle navigation">
                        <i class="fas fa-align-justify"></i>
                    </button>
                    <button type="button" id="sidebarCollapse" class="btn btn-info">
                        <i class="fas fa-align-left"></i>
                        <!-- <span>Toggle Sidebar</span> -->
                    </button>
                    <div class="collapse navbar-collapse" id="navbarSupportedContent">
                        <ul class="nav navbar-nav ml-auto">
                            <li class="nav-item active">
                                <a class="nav-link" onclick="signout()">退出</a>
                            </li>
                        </ul>
                    </div>
                </div>
            </nav>
        </header>
        <main role="main" class="container">
            <div class="row">
                <input type="text" style="display:none" id="plant">
                <input type="text" style="display:none" id="Jobseq">
                <input type="text" style="display:none" id="AssmbelNum">
                <div class="col-md-12 order-md-1">
                    <h4 class="mb-3">操作</h4>
                    <div class="mb-4">
                        <label for="txtBarcode">扫码：</label>
                        <div class="input-group">
                            <div class="input-group-prepend">
                                <span class="input-group-text">@</span>
                            </div>
                            <input type="text" class="form-control" id="txtBarcode" placeholder="扫码" onkeydown="BarcodeScan()">
                            <div class="invalid-feedback" style="width: 100%;">
                                Your username is required.
                            </div>
                        </div>
                    </div>
                    <!--<form>-->
                    <fieldset disabled>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="firstName">公司</label>
                                <input type="text" class="form-control" id="Company" placeholder="" value="" required="">
                                <div class="invalid-feedback">
                                    Valid first name is required.
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="lastName">供应商编号</label>
                                <input type="text" class="form-control" id="SupplierNo" placeholder="" value="" required="">
                                <div class="invalid-feedback">
                                    Valid last name is required.
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="firstName">供应商名称</label>
                                <input type="text" class="form-control" id="SupplierName" placeholder="" value="" required="">
                                <div class="invalid-feedback">
                                    Valid first name is required.
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="lastName">收件日期</label>
                                <input type="text" class="form-control" id="ReceiptDate" placeholder="" value="" required="">
                                <div class="invalid-feedback">
                                    Valid last name is required.
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="firstName">采购单号</label>
                                <input type="text" class="form-control" id="POnum" placeholder="" value="" required="">
                                <div class="invalid-feedback">
                                    Valid first name is required.
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="lastName">采购单行号</label>
                                <input type="text" class="form-control" id="POline" placeholder="" value="" required="">
                                <div class="invalid-feedback">
                                    Valid last name is required.
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="firstName">发货行</label>
                                <input type="text" class="form-control" id="POrelnum" placeholder="" value="" required="">
                                <div class="invalid-feedback">
                                    Valid first name is required.
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="lastName">物料编码</label>
                                <input type="text" class="form-control" id="Partnum" placeholder="" value="" required="">
                                <div class="invalid-feedback">
                                    Valid last name is required.
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="firstName">物料描述</label>
                                <input type="text" class="form-control" id="Partdescription" placeholder="" value="" required="">
                                <div class="invalid-feedback">
                                    Valid first name is required.
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="lastName">批次号</label>
                                <input type="text" class="form-control" id="BatchNo" placeholder="" value="" required="">
                                <div class="invalid-feedback">
                                    Valid last name is required.
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="firstName">炉批号</label>
                                <input type="text" class="form-control" id="HeatNum" placeholder="" value="" required="">
                                <div class="invalid-feedback">
                                    Valid first name is required.
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="lastName">工单号</label>
                                <input type="text" class="form-control" id="Jobnum" placeholder="" value="" required="">
                                <div class="invalid-feedback">
                                    Valid last name is required.
                                </div>
                            </div>
                        </div>
                    </fieldset>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="lastName">接收数量</label>
                            <input type="text" class="form-control" id="receiveQty" placeholder="" value="">
                            <div class="invalid-feedback">
                                Valid last name is required.
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="lastName">备注</label>
                            <input type="text" class="form-control" id="Remark" placeholder="" value="">
                            <div class="invalid-feedback">
                                Valid last name is required.
                            </div>
                        </div>
                    </div>
                    <hr class="mb-4">

                    <h4 class="mb-3">下一步办理人</h4>

                    <div class="d-block my-3">
                        <div class="col-md-4 mb-3">
                            <label for="state">请选择下一步办理人</label>
                            <select class="custom-select d-block w-100" id="SecondUserGroup" required="" multiple="multiple"></select>
                            <div class="invalid-feedback">
                                Please provide a valid state.
                            </div>
                        </div>
                    </div>

                    <hr class="mb-4">
                    <button class="btn btn-primary btn-lg btn-block" type="submit" onclick="Recvive()">收货</button>
                    <!--</form>-->
                </div>
            </div>
        </main>
        <footer class="site-footer footer pt-5 text-muted text-center text-small">
            <div class="container">
                <div class="text-center">
                    <p>
                        © Copyrights <strong>HS</strong>. All Rights Reserved
                    </p>
                    <!-- <div class="credits">
                            Created with Dashio template by <a href="https://templatemag.com/">TemplateMag</a>
                        </div> -->
                    <a href="#" class="go-top">
                        <i class="fas fa-angle-up"></i>
                    </a>
                </div>
            </div>
        </footer>

    </div>

    <div class="overlay"></div>
    <!-- jQuery CDN - Slim version (=without AJAX) -->
    <!--<script src="lib/jquery/jquery-3.3.1.slim.min.js"></script>-->
    <!-- Popper.JS -->
    <script src="../../lib/popper.min.js"></script>
    <!-- Bootstrap JS -->
    <script src="../../lib/bootstrap/js/bootstrap.bundle.min.js"></script>
    <!-- jQuery Custom Scroller CDN -->
    <script src="../../lib/mCustomScrollbar/jquery.mCustomScrollbar.concat.min.js"></script>

</body>

</html>